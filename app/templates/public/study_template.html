<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>index</title>
    <!-- Style  -->
    <link rel="stylesheet" type="text/css" href="/templates/public/css/study.css">
    <!-- Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css"
        integrity="sha384-SI27wrMjH3ZZ89r4o+fGIJtnzkAnFs3E4qz9DIYioCQ5l9Rd/7UAa8DHcaL8jkWt" crossorigin="anonymous">
</head>

<body>
    <nav class="menu navbar navbar-light">
        <a class="navbar-brand">PDF inspect</a>
        <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="/">Salir <span class="sr-only">(current)</span></a>
            </li>
        </ul>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md it">
                <div class="form-group">
                    <form id="formulario" class="save" action="{{url_for('getExcel')}}" method="POST">
                        <input type="text" class="form-control" id="nombre" name="pynombre"
                            placeholder="Nombre del estudio">
                        <!-- <div id="uploader" class="row"></div> -->
                        <input type="hidden" id="acepUser" value="" name="pyacepUser">
                        <!-- <a class="btn btn-new" title="suma archivos al estudio"> Añadir
                            PDF</a>
                        <a class="btn btn-next" onclick="sumarArchivos()" title="crea el estudio"> Añadir al estudio
                        </a> -->
                        <!-- <a class="btn btn-acep" href="#acep" title="añade palabras para localizar"
                            onclick="showPopupAcep();"> Acepciones</a> -->
                        <input class="btn btn-compare" id="view" onclick="showComparative();" value="">
                        <input type="hidden" id="listaAneca" value="" name="pylistadoAneca">
                        <input type="hidden" id="listaAcepciones" value="" name="pylistadoAneca">
                        <input type="submit" class="btn btn-pdf" value="Descargar">
                        <button id="botonEstudio" type="button" class="btn btn-upda">Guardar
                            Estudio</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row it">
        <form class="col-sm-offset-1 col-sm-10" id="upload-form" action="{{ url_for('anyadirArchivos') }}" method="POST"
            enctype="multipart/form-data">
            <div id="uploader" class="row">
                <div class="uploadDoc">
                    <div class="col-sm-10">
                        <div class="docErr">Por favor, elige un archivo valido</div>
                        <div class="fileUpload btn btn-orange">
                            <img src="https://image.flaticon.com/icons/svg/136/136549.svg" class="icon">
                            <span class="upl" id="upload">Subir documento</span>
                            <input type="hidden" id="acepUser" value="" name="pyacepUser">
                            <input type="hidden" id="pointOfStudy" value="" name="pointOfStudy">
                            <input class="form-control-file upload up" id="file-picker" type="file" name="file"
                                accept="pdf/*" onchange="readURL(this);">
                        </div>
                    </div>

                    <div class="col-sm-1">
                        <a class="btn-check"><i class="material-icons">delete_outline</i></a>
                    </div>
                </div>
            </div>
            <div id="listAcep"></div>
            <div class="text-center">
                <a class="btn btn-new" title="suma archivos al estudio"> Añadir nuevo</a>
                <a class="btn btn-acep" href="#acep" title="añade palabras para localizar" onclick="showPopupAcep();">Acepciones</a>
                <input type="submit" value="Comenzar" id="upload-button" class="btn btn-next" title="crea el estudio">
            </div>
        </form>
    </div>

    <div id="acep" class="overlay">
        <div class="popup">
            <h2>Acepciones</h2><a class="close" href="#" onclick="showDetail()">×</a>
            <div class="content">
                <label for="curriculum">Curriculum:</label>
                <input type="text" class="form-control" id="curriculum" placeholder="ej:campo 1,campo 2">
                <small>El sistema obtiene frases automáticamente con las palabras de la familia "currículum"</small>
                <br>
                <label for="coordinacion">Coordinación:</label>
                <input type="text" class="form-control" id="coordinacion" placeholder="ej:campo 1,campo 2">
                <small>El sistema obtiene frases automáticamente con las palabras de la familia "Docentia"</small>
                <br>
                <label for="web">Web:</label>
                <input type="text" class="form-control" id="web" placeholder="ej:campo 1,campo 2">
                <small>El sistema obtiene frases automáticamente con las palabras de la familia "web"</small> <br>
                <label for="docencia">Docentia:</label>
                <input type="text" class="form-control" id="docentia" placeholder="ej:campo 1,campo 2">
                <small> El sistema obtiene frases automáticamente con las palabras de la familia
                    "coordinación"</small> <br>
                <label for="otras">Otras:</label>
                <input type="text" class="form-control" id="otras" placeholder="ej:campo 1,campo 2">
                <small> El sistema obtiene frases automáticamente con las palabras de la familia "recomendar",
                    "aconsejar", "optimizar", "abandono" y con otras estructuras específicas formadas por "baja
                    respuesta", "baja satisfacción", "se propone", "se debe"</small> <br>
                <div class="text-center it">
                    <a class="btn btn-next" href="javascript:putAcep()" onclick="showDetail()"> Guardar</a>
                </div>
            </div>
        </div>
    </div>

    <div id="ErrorFiles" class="overlay">
        <div class="popup">
            <h2>Archivos no validos</h2><a class="close" href="#" onclick="closePopupErrorFilesHtml()">×</a>
            <div class="content">
                <p>Ha introducido contenido no reconocidos por el sistema</p>
            </div>
        </div>
    </div>


    <!-- vista detalle  -->

    {% block content_detail %}
    {% endblock %}

    <!-- vista comparativa -->

    {% block content_tabla %}
    {% endblock %}


</body>

</html>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/js/bootstrap.min.js"
    integrity="sha384-3qaqj0lc6sV/qpzrc1N5DC6i1VRn/HyX4qdPaiEFbn54VjQBEU341pvjz7Dv3n6P"
    crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
<script type="text/javascript" src="/templates/public/js/study.js"></script>
<!-- hacer pdf -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.22/pdfmake.min.js"></script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>

<script src="js/jquery.min.js"></script>
<script src="js/jsPDF/dist/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>

<script>
    var idStudy
    var study
    var myView = "detail"
    var ErrorFiles = false
    //Rellenamos los datos de la tabla
    $(document).ready(function () {
        var aux = '{{ data|safe }}'
        var datos = JSON.parse(aux)
        idStudy = datos.id
        showDetail()
        if (datos.hasOwnProperty('id')) {
            $.ajax({
                type: 'POST',
                url: "/verDetalles",
                data: aux,
                contentType: "application/json",
                encode: true,
                success: function rellena(res) {
                    study = res
                    detailHtml(res['comparativa'])
                    tablaHtml(res['comparativa'])
                    popupHtml(res['comparativa'])
                    document.getElementById("listaAneca").value = JSON.stringify(res['comparativa'])
                    getPDFs(res['comparativa'])
                    //Actualizamos el boton
                    document.getElementById("botonEstudio").setAttribute("onclick", "updateStudy()")
                    document.getElementById("botonEstudio").innerHTML = "Actualizar estudio"
                    document.getElementById("nombre").value = res['nombre']
                    document.getElementById("pointOfStudy").value = JSON.stringify(study)
                    console.log( document.getElementById("pointOfStudy").value)
                },
                error: function (res) {
                    alert("Algo ha fallado");
                }
            });
        } else {
            for (var i = 0; i < datos.length; i++) {
                if (datos[i] == false) {
                    datos.splice(i, 1)
                    ErrorFiles = true;
                    if (datos.length > 0)
                        i--
                }
            }

            if (ErrorFiles) {
                location.href = window.location + "#ErrorFiles"
                showPopupErrorFilesHtml()
            }

            if (datos.length == 0) {
                location.href = "http://localhost"
            }

            detailHtml(datos)
            tablaHtml(datos)
            popupHtml(datos)
            document.getElementById("botonEstudio").setAttribute("onclick", "saveStudy()")
            document.getElementById("botonEstudio").innerHTML = "Guardar estudio"
            document.getElementById("listaAneca").value = aux
            document.getElementById("pointOfStudy").value = aux
            pointOfStudy
            getPDFs(datos);
        }

        
    });



    function sumarArchivos() {

        var acep = document.getElementById("acepUser").value
        var estudio = JSON.stringify(study)
        var linkFiles = []
        var name

        for (i = 0; i < document.getElementsByClassName("form-control-file").length; i++) {
            name = document.getElementsByClassName("form-control-file")[i].value.split("\\")
            linkFiles.push(name[name.length - 1])
        }

        var allJson = {}
        allJson.study = estudio
        allJson.newFiles = linkFiles
        allJson.acep = acep

        var xmlhttp = new XMLHttpRequest();
        //Configuramos la conexion, variable.open("METODO", "URL","TIPO DE CONEXION" )
        xmlhttp.open("POST", "/addFiles", false)
        //Envias el header requerido para enviar parametros via POST
        xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
        //Enviamos la peticion
        xmlhttp.send(allJson)
        //Extraemos la información
        //var newfiles = JSON.parse(xmlhttp.responseText);
    }


    // Guardamos el estudio en la bd
    function saveStudy() {
        var name = document.getElementById("nombre").value;
        var elem_otras = 0
        var elem_curriculum = 0
        var elem_docentia = 0
        var elem_web = 0
        var elem_coordinacion = 0
        var estudio = {
            "nombre": name,
            "comparativa": []
        };
        var aux = '{{ data|safe }}'
        var datos = JSON.parse(aux);

        if (name == "") {
            document.getElementById("nombre").focus()
            return
        }

        for (var i in datos) {
            var item = datos[i];
            estudio.comparativa.push(item);
        }

        for (var i = 0; i < estudio.comparativa.length; i++) {
            for (var j = 0; j < estudio.comparativa[i]['recomendaciones']['curriculum'].length; j++) {
                if ($('#curriculum_' + i + elem_curriculum).prop('checked')) {
                    estudio.comparativa[i]['recomendaciones']['curriculum'].splice(j, 1)
                    j--
                }
                elem_curriculum++
            }

            for (var j = 0; j < estudio.comparativa[i]['recomendaciones']['docentia'].length; j++) {
                if ($('#docentia_' + i + elem_docentia).prop('checked')) {
                    estudio.comparativa[i]['recomendaciones']['docentia'].splice(j, 1)
                    j--
                }
                elem_docentia++
            }

            for (var j = 0; j < estudio.comparativa[i]['recomendaciones']['web'].length; j++) {
                if ($('#web_' + i + elem_web).prop('checked')) {
                    estudio.comparativa[i]['recomendaciones']['web'].splice(j, 1)
                    j--
                }
                elem_web++
            }

            for (var j = 0; j < estudio.comparativa[i]['recomendaciones']['coordinacion'].length; j++) {
                if ($('#coordinacion_' + i + elem_coordinacion).prop('checked')) {
                    estudio.comparativa[i]['recomendaciones']['coordinacion'].splice(j, 1)
                    j--
                }
                elem_coordinacion++
            }

            for (var j = 0; j < estudio.comparativa[i]['recomendaciones']['otras'].length; j++) {
                if ($('#otras_' + i + elem_otras).prop('checked')) {
                    estudio.comparativa[i]['recomendaciones']['otras'].splice(j, 1)
                    j--
                }
                elem_otras++
            }
        }

        $.ajax({
            type: 'POST',
            url: "/new",
            data: JSON.stringify(estudio),
            contentType: "application/json",
            encode: true,
            success: function (data) {
                window.location.href = "/";
            },
            error: function (data) {
                alert("Algo ha fallado");
            }
        });
        event.preventDefault();
    };



    function Export2() {
        window.scrollTo(0, 0)
        html2canvas(document.getElementById('table-scroll'), {
            onrendered: function (canvas) {
                // create intermediate canvas
                var rotCanvas = document.createElement("canvas");

                // swap width and height
                rotCanvas.width = canvas.height;
                rotCanvas.height = canvas.width;

                // get context
                var rctx = rotCanvas.getContext("2d");

                // translate to center (rotation pivot)
                rctx.translate(rotCanvas.width * 0.5, rotCanvas.height * 0.5);

                // rotate -90° (CCW)
                rctx.rotate(-Math.PI * 0.5);

                // draw image offset so center of image is on top of pivot
                rctx.drawImage(canvas, -canvas.width * 0.5, -canvas.height * 0.5);

                // extract image from rotate canvas
                //var data = rotCanvas.toDataURL('image/png');
                var data = canvas.toDataURL();

                var docDefinition = {
                    content: [{
                        allowTaint: true,
                        foreignObjectRendering: true,
                        image: data,
                        width: 500,
                    }]
                };
                pdfMake.createPdf(docDefinition).download("Table.pdf");

            }
        });

        window.scrollTo(0, document.body.scrollHeight || document.documentElement.scrollHeight)
    }



    function Export() {
        var doc = new jsPDF({
            orientation: "p", //set orientation
            unit: "pt", //set unit for document
            format: "letter" //set document standard
        });
        var elementHTML = $('#table-scroll').html();
        var specialElementHandlers = {
            '#elementH': function (element, renderer) {
                return true;
            }
        };
        margins = {
            top: 80,
            bottom: 60,
            left: 40,
            width: 522
        };

        doc.fromHTML(elementHTML, margins.left, // x coord
            margins.top, {

            'width': 30,
            'elementHandlers': specialElementHandlers
        });

        // Save the PDF
        doc.save('sample-document.pdf');
    }


    function Export4() {

        var doc = new jsPDF('p', 'pt');

        var res = doc.autoTableHtmlToJson(document.getElementById("table-scroll"));
        doc.autoTable(res.columns, res.data, { margin: { top: 80 } });

        var header = function (data) {
            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.setFontStyle('normal');
            //doc.addImage(headerImgData, 'JPEG', data.settings.margin.left, 20, 50, 50);
            doc.text("Testing Report", data.settings.margin.left, 50);
        };

        var options = {
            beforePageContent: header,
            margin: {
                top: 80
            },
            startY: doc.autoTableEndPosY() + 20
        };

        doc.autoTable(res.columns, res.data, options);

        doc.save("table.pdf");
    }

    function Export6() {
        console.log('entro')
        var pdf = new jsPDF('p', 'pt', 'letter');
        // source can be HTML-formatted string, or a reference
        // to an actual DOM element from which the text will be scraped.
        source = $('#customers')[0];

        // we support special element handlers. Register them with jQuery-style 
        // ID selector for either ID or node name. ("#iAmID", "div", "span" etc.)
        // There is no support for any other type of selectors 
        // (class, of compound) at this time.
        specialElementHandlers = {
            // element with id of "bypass" - jQuery style selector
            '#bypassme': function (element, renderer) {
                // true = "handled elsewhere, bypass text extraction"
                return true
            }
        };
        margins = {
            top: 80,
            bottom: 60,
            left: 40,
            width: 522
        };
        // all coords and widths are in jsPDF instance's declared units
        // 'inches' in this case
        pdf.fromHTML(
            source, // HTML string or DOM elem ref.
            margins.left, // x coord
            margins.top, {// y coord
            'width': margins.width, // max width of content on PDF
            'elementHandlers': specialElementHandlers
        },
            function (dispose) {
                // dispose: object with X, Y of the last line add to the PDF 
                //          this allow the insertion of new lines after html
                pdf.save('Test.pdf');
            }
            , margins);
    }

</script>